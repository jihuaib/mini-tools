name: Release to GitHub and Gitee

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and Release
        run: npm run release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release info
        id: release
        run: |
          $tag = "${{ github.ref_name }}"
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$($tag -replace '^v', '')" >> $env:GITHUB_OUTPUT

      - name: Sync to Gitee
        run: |
          git remote add gitee git@gitee.com:muping18/NetNexus.git
          git push gitee ${{ github.ref_name }}
        continue-on-error: true

      - name: Upload to Gitee Release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const https = require('https');
            
            const token = process.env.GITEE_TOKEN;
            const tag = '${{ steps.release.outputs.tag }}';
            
            if (!token) {
              console.log('GITEE_TOKEN not set, skipping Gitee release');
              return;
            }
            
            // Create Gitee release
            const createRelease = () => {
              return new Promise((resolve, reject) => {
                const data = JSON.stringify({
                  access_token: token,
                  tag_name: tag,
                  name: `NetNexus ${tag}`,
                  body: 'Auto release from GitHub Actions',
                  prerelease: false
                });
                
                const options = {
                  hostname: 'gitee.com',
                  path: '/api/v5/repos/muping18/NetNexus/releases',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                };
                
                const req = https.request(options, (res) => {
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    if (res.statusCode === 201) {
                      console.log('✅ Gitee release created');
                      resolve(JSON.parse(body));
                    } else {
                      console.log('⚠️ Gitee release response:', body);
                      resolve(null);
                    }
                  });
                });
                
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            };
            
            await createRelease();
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
